<!doctype html><html lang=en><head><title>Collecting Data while walkng a filesystem with Go :: Notes by Grayside</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Using `fs.WalkDir` to collect data."><meta name=keywords content=","><meta name=robots content="noodp"><link rel=canonical href=https://notes.grayside.dev/posts/go/walkdir-collection/><link rel=stylesheet href=https://notes.grayside.dev/styles.css><link rel="shortcut icon" href=https://notes.grayside.dev/img/theme-colors/green.png><link rel=apple-touch-icon href=https://notes.grayside.dev/img/theme-colors/green.png><meta name=twitter:card content="summary"><meta name=twitter:site content="notes.grayside.dev"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Collecting Data while walkng a filesystem with Go"><meta property="og:description" content="Using `fs.WalkDir` to collect data."><meta property="og:url" content="https://notes.grayside.dev/posts/go/walkdir-collection/"><meta property="og:site_name" content="Notes by Grayside"><meta property="og:image" content="https://notes.grayside.dev/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2023-02-06 09:18:54 -0800 -0800"><link rel=stylesheet href=https://notes.grayside.dev/override.e21dd114395c0dc676debb1974e94e71df75cb14dc7f8cc7f05481cdf9b716b0.css fingerprint="sha256-4h3RFDlcDcZ23rsZdOlOcd91yxTcf4zH8FSBzfm3FrA="></head><body class=green><div class=container><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Notes</div></a></div></div></header><div class=content><article class=post><h1 class=post-title><a href=https://notes.grayside.dev/posts/go/walkdir-collection/>Collecting Data while walkng a filesystem with Go</a></h1><div class=post-meta><time class=post-date>2023-02-06</time>
:: <span class=post-author>grayside</span>
:: <span class=post-reading-time>2 min read (244 words)</span></div><span class=post-tags>#<a href=https://notes.grayside.dev/tags/til/>til</a>&nbsp;
#<a href=https://notes.grayside.dev/tags/golang/>golang</a>&nbsp;
#<a href=https://notes.grayside.dev/tags/lexical-scope/>lexical-scope</a>&nbsp;
#<a href=https://notes.grayside.dev/tags/filesystem/>filesystem</a>&nbsp;</span><div class=post-content><div><p>There are several ways to use <a href=https://pkg.go.dev/io/fs#WalkDir><code>fs.WalkDir</code></a>
to collect data.</p><h2 id=basic-fswalkdir>Basic <code>fs.WalkDir</code><a href=#basic-fswalkdir class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Here&rsquo;s a relatively simple WalkDir to print all paths that start with &ldquo;magic/&rdquo;.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ImportantBusinessFunc</span>(<span style=color:#a6e22e>fsys</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>FS</span>) (<span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>WalkDir</span>(<span style=color:#a6e22e>fsys</span>, <span style=color:#e6db74>&#34;.&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>dir</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>DirEntry</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasPrefix</span>(<span style=color:#a6e22e>path</span>, <span style=color:#e6db74>&#34;magic/&#34;</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This doesn&rsquo;t help because I want to collect those paths, not just print them out.</p><h2 id=add-collector-slice>Add Collector Slice<a href=#add-collector-slice class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Assemble data by instantiating a collector that we can add to as we walk.</p><p>(WalkDir is not concurrent.)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ImportantBusinessFunc</span>(<span style=color:#a6e22e>fsys</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>FS</span>) ([]<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>string</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>WalkDir</span>(<span style=color:#a6e22e>fsys</span>, <span style=color:#e6db74>&#34;.&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>dir</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>DirEntry</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasPrefix</span>(<span style=color:#a6e22e>path</span>, <span style=color:#e6db74>&#34;magic/&#34;</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span> = append(<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The function passed as a parameter to <code>fs.WalkDir</code> is a closure, and lexical scoping
means variables defined in ImportantBusinessFunc are available inside contained closures.</p><h2 id=pointer-to-a-collection>Pointer to a Collection<a href=#pointer-to-a-collection class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Suppose we want the file walking to be more reusable?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ImportantBusinessFunc</span>(<span style=color:#a6e22e>fsys</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>FS</span>) ([]<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>string</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>_importantBusiness</span>(<span style=color:#a6e22e>fsys</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>s</span>, <span style=color:#e6db74>&#34;magic/&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_importantBusiness</span>(<span style=color:#a6e22e>fsys</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>FS</span>, <span style=color:#a6e22e>collector</span> <span style=color:#f92672>*</span>[]<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>needle</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>WalkDir</span>(<span style=color:#a6e22e>fsys</span>, <span style=color:#e6db74>&#34;.&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>dir</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>DirEntry</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasPrefix</span>(<span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>needle</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>collector</span> = append(<span style=color:#a6e22e>collector</span>, <span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://notes.grayside.dev/posts/this/site/><span class=button__text>Planning notes.grayside.dev</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>&copy;2023 Adam Ross :: Powered by <a href=http://gohugo.io>Hugo</a></span></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>